/*! Compiled on: 2014-06-05 */
"use strict";define(["modules/app","usersFactory","authenticationFactory","facebook"],function(app){app.directiveManager("authentication",["$cookies","$compile","$rootScope","$injector","authenticationFactory","usersFactory","$loading",function($cookies,$compile,$rootScope,$injector,authenticationFactory,usersFactory){return{restrict:"E",controller:"authenticationCtrl",replace:!0,template:'<div class="user-authentication"></div>',link:function($scope,$element){var authenticateHTML='<a ng-click="openSignUpModal()">Sign Up</a> or <a ng-click="openSignInModal()" href="#">Log In</a>',currentStatus="",setElement=function(status){if(status="authenticated"){var account='<a ng-if="favoritesCount > 0" class="favorites" ng-click="go($event)" href="/account">{{ favoritesCount }}<i class="icon-heart"></i></a>';account+='<span ng-if="favoritesCount > 0" class="separator"></span>',account+='<a href="#" ng-click="signOut()" class="sign-out"><i class="icon-signout"></i>Sign Out</a>',$element.html(account),$compile($element.contents())($scope),usersFactory.getCurrentUserFromAPI().then(function(user){$rootScope.favoritesCount=void 0!==user.favorites?user.favorites.length:0},function(){$element.html(authenticateHTML),$compile($element.contents())($scope)})}else currentStatus="loggedout",$element.html(authenticateHTML),$compile($element.contents())($scope)};authenticationFactory.isLoggedIn()?(currentStatus="loggedin",setElement("authenticated")):(currentStatus="loggedout",setElement("notAuthenticated")),authenticationFactory.on("authentication",function(action){currentStatus!=action&&("loggedin"==action?(currentStatus="loggedin",setElement("authenticated")):(currentStatus="loggedout",setElement("notAuthenticated")))})}}}]),app.controllerManager("authenticationCtrl",["$rootScope","$scope","$modal","$cookies","$location","usersFactory","authenticationFactory",function($rootScope,$scope,$modal,$cookies,$location,usersFactory,authenticationFactory){$rootScope.signOut=function(){authenticationFactory.signOut()},$rootScope.openSignInModal=function(){authenticationFactory.openSignInModal()},$rootScope.openSignUpModal=function(){authenticationFactory.openSignUpModal()},$rootScope.openForgotPasswordModal=function(){authenticationFactory.openForgotPasswordModal()}}]),app.controllerManager("authenticationInstanceCtrl",function($rootScope,$injector,$scope,$modalInstance,$http,$cookies,$timeout,config,usersFactory,authenticationFactory,message,onSuccess,$location,$loading,$modal){$scope.message=message;var signInComplete=function(){onSuccess&&onSuccess(),authenticationFactory.trigger("authentication","loggedin"),$modalInstance.close()};$scope.close=function(){$modalInstance.close()},$scope.submitForgotPassword=function(){$loading.start(),$http({method:"POST",data:{email:this.email},url:"/forgotpassword"}).success(function(){$loading.end(),$modalInstance.close(),$modal.open({templateUrl:"/release/html/partials/forgotPasswordConfirm.html",controller:function($scope,$modalInstance){$scope.close=function(){$modalInstance.close()}}})}).error(function(){$loading.end(),$scope.error=!0,$scope.message="We can't find your email in our system. Please make sure it's the one you used during sign up."})},$scope.signIn=function(){$loading.start(),void 0!==this.email&&void 0!==this.password&&$http({method:"POST",data:{username:this.email,password:this.password,grant_type:"password",account_type:"email"},url:"/signin"}).success(function(data,status,headers){headers("access-token")&&(ga("send","event","authentication","signin","email"),$cookies.set("access_token",headers("access-token")),$cookies.set("refresh_token",headers("refresh-token")),$cookies.set("token_expiry",headers("expiration")),usersFactory.getCurrentUserFromAPI().then(function(user){$loading.end(),"venue"==user.type?($cookies.remove("access_token"),$cookies.remove("refresh_token"),$cookies.remove("token_expiry"),$scope.error=!0,$scope.message="It looks like you're a venue.<br />To sign in, please go <a href='http://venues.thehitch.com'>here</a>."):signInComplete(headers)}))}).error(function(data){$loading.end(),$scope.error=!0,$scope.message=data.error.message})},$scope.fbLogin=function(){FB.init(config.facebook),$loading.start(),FB.login(function(response){$http({method:"POST",data:{grant_type:"Hitch",account_type:"facebook",access_token:response.authResponse.accessToken},url:"/signin"}).success(function(data,status,headers){headers("access-token")?(data.new_user?ga("send","event","authentication","signup","facebook"):ga("send","event","authentication","signin","facebook"),$cookies.set("access_token",headers("access-token")),$cookies.set("refresh_token",headers("refresh-token")),$cookies.set("token_expiry",headers("expiration")),usersFactory.getCurrentUserFromAPI().then(function(){$loading.end(),signInComplete(headers)},function(){$loading.end(),$scope.error=!0,$scope.message="There was an error with Facebook, please try again."})):console.log("No Access Token in Header")}).error(function(){console.log("Facebook Auth Error")})},{scope:"email"})},$scope.twLogin=function(){$loading.start();var left=screen.width/2-390,top=screen.height/2-360;window.open("/twitter","twitter","directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width=780,height=720,top="+top+",left="+left),require(["twitterFactory"],function(){var twitterFactory=$injector.get("twitterFactory");twitterFactory.login().then(function(tokens){$http({method:"POST",data:{grant_type:"Hitch",account_type:"twitter",oauth_token:tokens.twitterAccessToken,oauth_token_secret:tokens.twitterAccessTokenSecret},url:"/signin"}).success(function(data,status,headers){headers("access-token")&&(data.new_user?ga("send","event","authentication","signup","twitter"):ga("send","event","authentication","signin","twitter"),$cookies.set("access_token",headers("access-token")),$cookies.set("refresh_token",headers("refresh-token")),$cookies.set("token_expiry",headers("expiration")),usersFactory.getCurrentUserFromAPI().then(function(){$loading.end(),signInComplete(headers)},function(){$loading.end(),$scope.error=!0,$scope.message="There was an error with Twitter, please try again."}))}).error(function(){})})})},$scope.signUp=function(){void 0!==this.email&&void 0!==this.password?($loading.start(),$scope.error=!1,$scope.message=message,$http({method:"POST",data:{username:this.email,password:this.password,first_name:this.first_name,last_name:this.last_name,account_type:"email",grant_type:"Hitch",type:"user"},url:"/signup"}).success(function(data,status,headers){$loading.end(),ga("send","event","authentication","signup","email"),$cookies.set("access_token",headers("access-token")),$cookies.set("refresh_token",headers("refresh-token")),$cookies.set("token_expiry",headers("expiration")),usersFactory.getCurrentUserFromAPI().then(function(){$loading.end(),signInComplete(headers)},function(){$loading.end(),$scope.error=!0,$scope.message="There was an error, please try again later."})}).error(function(data){switch($loading.end(),$scope.message=data.error.message,data.error.input){case"username":$scope.emailError=!0}$scope.error=!0})):$scope.message="error"}})});